---
title: 'Supplement to: "HaDeX: Analysis and Visualisation of Hydrogen/Deuterium Exchange Mass Spectrometry Data"'
author: "Weronika Pucha&#322;a, Micha&#322; Burdukiewicz, Micha&#322; Kistowski, Katarzyna A. D&#261;browska, Aleksandra E. Badaczewska-Dawid, Dominik Cysewski, Micha&#322; Dadlez"
date: "15.02.2019"
output: 
  rmarkdown::html_vignette:
    toc: true
    number_sections: true
    always_allow_html: yes
vignette: >
  %\VignetteIndexEntry{HaDeX: Analysis and Visualisation of Hydrogen/Deuterium Exchange Mass Spectrometry Data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, echo = FALSE, message = FALSE, results='asis'}
library(HaDeX)
library(ggplot2)
library(knitr)
library(DT)
opts_chunk$set(fig.width = 7, fig.height = 5)
```

 
# About HaDeX

Hydrogen-deuterium mass spectrometry (HDX-MS) is a staple tool for monitoring dynamics and interactions of proteins. Due to the sheer size of the HDX-MS results, the data analysis require a dedicated software suite. However, the majority of existing tools provides only point-and-click interfaces to black-box models or does not offer a complete workflow. We propose HaDeX, a novel tool for processing, analysis and visualisation of HDX-MS experiments. HaDeX covers the whole analytic process, including preliminary data exploration, quality control and generation of publication-quality figures. 

To make the HaDeX **R** package available to the less **R**-fluent users, we enhanced it with a comprehensive Graphical User Interface available as a HaDeX Shiny app. The reproducibility of the whole procedure is ensured with advanced reporting functions. The app is availble online: http://mslab-ibb.pl/shiny/HaDeX/ or locally through the HaDeX_gui() fuction.

## Comparison of the existing HDX-MS software

```{r echo=FALSE,results='asis'}
read.csv2("comparison.csv") %>% 
  datatable(options = list(dom = "t", ordering = FALSE, paging = FALSE), rownames = FALSE, style = "bootstrap") %>%
  #formatStyle(c("MEMHDX", "Deuteros", "HaDeX"), backgroundColor = styleEqual("Yes", "blue")) %>% 
  formatStyle(c("MEMHDX", "Deuteros", "HaDeX"), backgroundColor = styleEqual("No", "red"))
```


# General data manipulation

## Input file format 

The HaDeX web server works only on data in the DynamX\textsuperscript{TM} datafile format (Waters Corp.). It must contains a following set of columns with specified properties:

```{r warning=FALSE, message=FALSE, echo = FALSE}

datatable(
  data = data.frame("Column Name" = c("Protein", "Start", "End", "Sequence", "Modification", "Fragment", "MaxUptake", "MHP", "State", "Exposure", "File", "z", "RT", "Inten", "Center"),
                    "Column Type" = c("Character", "Integer", "Integer", "Character", "Logic", "Logic", "Numeric", "Numeric", "Character", "Numeric", "Character", "Integer", "Numeric", "Numeric", "Numeric")),
  rownames = FALSE,
  options = list(dom = "t", autoWidth = TRUE, pageLength = 15))

```

Although data can be imported into R using other tools, we strongly advice to rely on the *read_hdx()* function:

```{r warning=FALSE}

dat <- read_hdx(system.file(package = "HaDeX", 
                            "HaDeX/data/KD_190304_Nucb2_EDTA_CaCl2_test02_clusterdata.csv"))

```

Currently, *read_hdx()* supports .csv, .tsv and .xls files fullfilling the data structure described above. 

## Peptide coverage

The sequence of protein(s) is reconstructed from the input file and based of provided peptides. Thus, parts of the sequences not covered by peptides are marked as X according to the IUPAC convention for unknown amino acids. The sequence is reconstructed using the reconstruct_sequence function.

```{r warning=FALSE}

reconstruct_sequence(dat)

```

Additionally, the coverage of peptides can be presented on a chart using the graphic_overlapping() function. 

```{r warning=FALSE}

graphic_overlapping(dat, chosen_state = "gg_Nucb2_CaCl2")

```

User can choose which state (or states) should be included in shown data. If this parameter is not supplied, the first possible state is chosen. If a given peptide is available in more than one state, it is shown only once. 


# Data preparation for deuteration calculations

There are a few steps of preliminary data preparation. All of the listed transformation in this section is done by prepare_dataset() function. Product of calling prepare_dataset() on data read by read_hdx() is later referred as calc_dat.

#### Measured data to useful value

DynamX provides experimental data as measured mass plus proton mass to charge ratio ($Center$). For later use, this value has to be transformed into overall peptide mass, as shown in equation 1: 

$$expMass = z \times (Center-protonMass)\tag{1}$$
where:

- $expMass$ - result calculated from partial values

- $z$ - charge

- $Center$ - experimentally measured value - mass plus proton mass per charge ratio

This transformation is applied to every measurement. 

The experiment is repeated at least three times for the results to be reliable. Then, the repetitions are aggregated as weighted mean into one result per peptide using equation 2: 

$$expMass = \frac{Inten \times expMass}{N}\tag{2}$$
where:

- $Inten$ - Intensivity

- $N$ - number of repetitions

In input file is data from more than one measurement. The mean value for each time in each state is treated as a result. This means that the uncertainty is calculated using the standard deviation of the mean:

$$u(x) = \sqrt{\frac{ \sum_{i=1}^n \left( x_{i} - \overline{x} \right)^2}{n(n-1)}}\tag{3}$$
where:

- $x_{i}$ - measurement
 
- $\overline{x}$ - mean value

- $n$ - number of measurements

#### Experimental deuteration level

In HDX-MS experiments the subject of interest is deuteration level exchanged in a given time between two states. 
Generally, the experimental relative deuteration level is calculated as shown in equation 4. It is a function of three variables and produces a value for the chosen state and chosen time $t$.  

$$D = \frac{D_{t} - D_{0}}{D_{100} - D_{0}}\tag{4}$$

where:

- $D$ - deuteration level (relative value)

- $D_{0}$ - deuteration in $in$ time (0 or close to 0, measured) - mean value obtained as explained before

- $D_{100}$ - deuteration in $out$ time (possibly big, at least 1440 [min]) - mean value obtainted as explained before

- $D_{t}$ - deuteration measured in chosen time - mean value obtainted as explained before

Although equation 4 produces relative value, absolute values are also calculated in HaDeX adjusting the equation to its variance as shown in equation 4a:

$$D = D_{t} - D_{0}\tag{4a}$$
Functions in HaDeX package contain logical value $relative$ to determine if values should be absolute or relative. Methodology below is described on relative values for readability. Absolute values are obtained analogical way, but without scaling. 

# Uncertainty calculations

The uncertainty of measurement is variability associated with the precision of measuring instrumentation. To the best of our knowledge, we present here the first derivation of uncertainty formulas for HDX-MS data. To calculate uncertainty related to functions of more than one variables (eq. equation 4) the Law of propagation of uncertainty is defined by equation 5:

$$u_{c}(y) = \sqrt{\sum_{k} \left[ \frac{\partial y}{\partial x_{k}} u(x_{k}) \right]^2}\tag{5}$$


We assume uncorrelatedness of HDX-MS measurements, because XXX.

After adapting the equation 5 using formula from equation 4, uncertainty of equation 4 is calculated as follows:

$$u_{c}(D) = \sqrt{\sum_{k} \left[ \frac{\partial D}{\partial D_{k}} u(D_{k}) \right]^2 }\tag{6}$$

where:

- $k \in {0, t, 100}$

- $D_{k}$ - deuteration in k time 

- $u(D_{k})$ - uncertainty associated with $D_{k}$ as standard deviation of the mean value 

Then, expanding the equation 6:

$$u_{c}(D) = \sqrt{ \left[ \frac{1}{D_{100}-D_{0}} u(D_{t}) \right]^2 + \left[ \frac{D_{t} - D_{100}}{(D_{100}-D_{0})^2} u(D_{0}) \right]^2 + \left[ \frac{D_{0} - D_{t}}{(D_{100}-D_{0})^2} u(D_{100}) \right]^2}\tag{7}$$
As suspected, the uncertainty associated with $D_{t}$ has the biggest impact on $u_{c}(D)$.

#### Theoretical deuteration level 

Other way to examine the data rather then experimental way are the theoertical calculations - obtained relative deuteration level in chosen time $t$ is compared with theoretical values as shown in equation 8:

$$D = \frac{D_{t}-MHP}{MaxUptake \times protonMass}\tag{8}$$

where:

- $D_{t}$ - deuteration measured in chosen time

- $MHP$ - theoretical mass for peptide (constant)

- $MaxUptake$ - max proton uptake for peptide (constant)

- $protonMass$ - mass of a proton (constant).

Absolute value is calculates as in equation 8 without scalling, as shown in equation 8a:

$$D = D_{t} - MHP\tag{8a}$$

The uncertainty of the function of one variable is defined by the equation 9:

$$u(y) = \left| \frac{dy}{dx} u(x) \right|\tag{9}$$

and based on equation 8:

$$u(D) = \left|\frac{1}{MaxUptake \times protonMass} u(D_{t}) \right|\tag{10}$$

For the absolute values, $u(D)$ is identical with $u(D_{t})$, based on equation 8a and 9.

## Difference of deuteration levels between two states 

Interesting observance can be gained from analysing the difference of deuteration levels in given time $t$ between two states as shown in plot in Woods format. For this, deuteration level in one state $(D_{2})$ is subtracted from deuteration level in other state $(D_{1})$:

$$diff = D_{1} - D_{2}\tag{11}$$

and the uncertainty of function of two variables (based on equation 11 and 5):

$$u_{c}(diff) = \sqrt{u(D_{1})^2 + u(D_{2})^2}\tag{12}$$
All of the previous calculations are done by function prepare_dataset(). Example of use:

```{r warning=FALSE}
calc_dat <- prepare_dataset(dat,
                            in_state_first = "gg_Nucb2_EDTA_0.001",
                            chosen_state_first = "gg_Nucb2_EDTA_25",
                            out_state_first = "gg_Nucb2_EDTA_1440",
                            in_state_second = "gg_Nucb2_CaCl2_0.001",
                            chosen_state_second = "gg_Nucb2_CaCl2_25",
                            out_state_second = "gg_Nucb2_CaCl2_1440") 
```

## Comparison plot

Comparison plots show the peptide deuteration level. The x-axis represents positions of amino acids in the sequence. On the y-axis shows the level of exchange: *relative* (to the maximum deuteration) or *absolute* (in Daltons). The chart below shows peptide deuteration after 25 minutes of the incubation along with the confidence intervals. The maximum deuteration can be also computed in two different ways: either as *theoretical* (where the maximum duteration depends on the theoretical deuteration levels) and *experimental* (where the maximum deuteration is assumed to be equal to the deuteration measured at the last timepoint).

-- theoretical:

- relative values:

```{r warning=FALSE}
comparison_plot(calc_dat = calc_dat,
                theoretical = TRUE,
                relative = TRUE,
                state_first = "Nucb2 Factor 1",
                state_second = "Nucb2 Factor 2") +
  labs(title = "Theoretical fraction exchanged in state comparison in 25 min time")
```

- absolute values:

```{r warning=FALSE}
comparison_plot(calc_dat = calc_dat,
                theoretical = TRUE,
                relative = FALSE,
                state_first = "Nucb2 Factor 1",
                state_second = "Nucb2 Factor 2") +
  labs(title = "Theoretical fraction exchanged in state comparison in 25 min time")
```

-- experimental:

- relative values:

```{r warning=FALSE}
comparison_plot(calc_dat = calc_dat,
                theoretical = FALSE,
                relative = TRUE, 
                state_first = "Nucb2 Factor 1",
                state_second = "Nucb2 Factor 2") +
  labs(title = "Fraction exchanged in state comparison in 25 min time")
```

- absolute values:

```{r warning=FALSE}
comparison_plot(calc_dat = calc_dat,
                theoretical = FALSE,
                relative = FALSE, 
                state_first = "Nucb2 Factor 1",
                state_second = "Nucb2 Factor 2") +
  labs(title = "Fraction exchanged in state comparison in 25 min time")
```


## Woods plot

Woods plot format shows the difference between the results of two different states as described by equation 11. Similarly to the comparison plot, HaDeX provides both experimental and theoretical calculations using either relative or absolute values:

-- theoretical:

- relative values:

```{r warning=FALSE}
woods_plot(calc_dat = calc_dat,
           theoretical = TRUE,
           relative = TRUE) +
  labs(title = "Theoretical fraction exchanged between states in 25 min time")
```

- absolute values:

```{r warning=FALSE}
woods_plot(calc_dat = calc_dat,
           theoretical = TRUE,
           relative = FALSE) +
  labs(title = "Theoretical fraction exchanged between states in 25 min time")
```

-- experimental:

- relative values:

```{r warning=FALSE }
woods_plot(calc_dat = calc_dat,
           theoretical = FALSE, 
           relative = TRUE) +
  labs(title = "Theoretical fraction exchanged between states in 25 min time")
```

- absolute values:

```{r warning=FALSE }
woods_plot(calc_dat = calc_dat,
           theoretical = FALSE, 
           relative = FALSE) +
  labs(title = "Theoretical fraction exchanged between states in 25 min time")
```


### Confidence limit in Woods plot

The function calculate_confidence_limit_values() calculates confidence limit values as it is described elsewhere (Houde, D., Berkowitz, S.A., and Engen, J.R. (2011). The Utility of Hydrogen/Deuterium Exchange Mass Spectrometry in Biopharmaceutical Comparability Studies. J Pharm Sci 100, 2071–2086). 

```{r}
calculate_confidence_limit_values(calc_dat = calc_dat,
                                  confidence_limit = 0.99,
                                  theoretical = FALSE, 
                                  relative = TRUE)  
``` 

Function add_stat_dependency() returns data extended by column describing relation of a given peptide with confidence limit.

```{r}
add_stat_dependency(calc_dat, 
                   confidence_limit = 0.98, 
                   theoretical = FALSE, 
                   relative = TRUE)
```

# Additional tools

HaDeX provides additional tools for assement of experiments. 

## Quality control 

Function quality_control() shows how the mean deuteration uncertainty per peptide changes with time points of an experiment. Therefore, a user can detect a time point after which the decrease of the deuteration uncertainty becomes too marginal to prolong the measurements. This function is the most useful in the case of multiple measurements of the same or very similar proteins, where it allows to optimize the duration of the incubation.

Example:

```{r warning=FALSE}
result <- quality_control(dat = dat,
                          state_first = "gg_Nucb2_EDTA",
                          state_second = "gg_Nucb2_CaCl2", 
                          chosen_time = 25, 
                          in_time = 0.001, 
                          relative = TRUE)

```

The function returns an object of the data.frame class, that can be easily visualized.

```{r warning=FALSE}
ggplot(result[result["time"]>=1,]) + 
  geom_line(aes(x = time, y = avg_err_state_first, color = "Average error (first state)")) +
  geom_line(aes(x = time, y = avg_err_state_second, color = "Average error (second state)")) +
  scale_x_log10() +
  labs(x = "log(time) [min]", y = "Average uncertainty", title = "Uncertainty change") + 
  theme_bw(base_size = 11) +
  theme(legend.position = "bottom",
        legend.title = element_blank())
```

Example above is based on relative values. Although HaDeX provides results in absolute values, be aware that absolute calculations do not
encompass time out (it is used for scaling), so the uncertainty is not the function of $D_{100}$, but is constant. 

# HaDeX Graphical User Interface

All of the functions mentioned below are wrapped together in the HaDeX Shiny app. It is launched by the HaDeX_gui() function.

# Example workflow

1. File import
2. Sequence reconstruction
3. Woods plots.

## Example workflow 1

```{r warning=FALSE}
library(HaDeX)

# file import
dat_1 <- read_hdx(system.file(package = "HaDeX", 
                              "HaDeX/data/KD_180110_CD160_HVEM.csv"))

# protein sequence reconstruction
reconstruct_sequence(dat_1)
```

On the theoretical plot are visible regions, which exchange quickly (N terminal part, regions between 30-70 amino acid) and regions, which exchange slowly (peptides 15-24, 95-110 amino acid). We can also see the differences in exchange between two states, indicating regions which changed upon binding with other protein.

```{r warning=FALSE}
# calculate data
calc_dat_1 <- prepare_dataset(dat = dat_1,
                              in_state_first = "CD160_0.001",
                              chosen_state_first = "CD160_1",
                              out_state_first = "CD160_1440",
                              in_state_second = "CD160_HVEM_0.001",
                              chosen_state_second = "CD160_HVEM_1",
                              out_state_second = "CD160_HVEM_1440")                             

# theoretical comparison plot - relative values
comparison_plot(calc_dat = calc_dat_1,
                theoretical = TRUE,
                relative = TRUE, 
                state_first = "CD160",
                state_second = "CD160_HVEM")

```

On the experimental plot are visible regions, which exchange quickly (N terminal part, regions between 30-70 amino acid) and regions, which exchange slowly (peptides 15-24, 30-35, 95-110 amino acid). 

```{r warning=FALSE}
# experimental comparison plot - relative values
comparison_plot(calc_dat = calc_dat_1,
                theoretical = FALSE,
                relative = TRUE,
                state_first = "CD160",
                state_second = "CD160_HVEM")

```

Plots below are equivalent to plots above but in absolute values - for users that prefer those.

```{r warning=FALSE}
# theoretical comparison plot - absolute values
comparison_plot(calc_dat = calc_dat_1,
                theoretical = TRUE,
                relative = FALSE, 
                state_first = "CD160",
                state_second = "CD160_HVEM")

# experimental comparison plot - absolute values
comparison_plot(calc_dat = calc_dat_1,
                theoretical = FALSE,
                relative = FALSE,
                state_first = "CD160",
                state_second = "CD160_HVEM")


```

What we see here?

Wood’s plot is a different way of presenting the same data as in comparison plot. In Wood’s plot the levels of peptides’ deuteration (either relative or absolute) are subtracted between states and presented with error bars.
The plot below shows peptides, which levels of deuteration were significantly lower upon binding with other protein (red) and peptides, which levels of exchange were significantly higher upon binding with other protein (blue). The plot also show peptides in which no significant changes in deuteration between states are visible (grey). The biggest changes on the theoretical plot can be observed in 3 peptides (15-24, 30-35, 75-90). 

```{r warning=FALSE}
  

# theoretical Woods plot - relative values
woods_plot(calc_dat = calc_dat_1,
           theoretical = TRUE, 
           relative = TRUE) +
  coord_cartesian(ylim = c(-.2, .2))

```

The biggest changes on the experimental plot can be observed in 3 peptides (15-24, 110-115).

```{r warning=FALSE}
# experimental Woods plot - relative values
woods_plot(calc_dat = calc_dat_1,
           theoretical = FALSE,
           relative = TRUE) +
  coord_cartesian(ylim = c(-.2, .2))

```

Plot below show results in absolute values.

```{r warning=FALSE}
# theoretical Woods plot - absolute values
woods_plot(calc_dat = calc_dat_1,
           theoretical = TRUE, 
           relative = FALSE) +
  labs(title = "Theoretical fraction exchanged between states in 1 min time") 

# experimental Woods plot - absolute values
woods_plot(calc_dat = calc_dat_1,
           theoretical = FALSE,
           relative = FALSE) +
  labs(title = "Fraction exchanged between states in 1 min time") 

# quality control - relative values 
(result <- quality_control(dat = dat_1,
                state_first = "CD160",
                state_second = "CD160_HVEM", 
                chosen_time = 1, 
                in_time = 0.001))

# example quality control visualisation
library(ggplot2)
ggplot(result) + 
  geom_line(aes(x = time, y = avg_err_state_first, color = "Average error (first state)")) +
  geom_line(aes(x = time, y = avg_err_state_second, color = "Average error (second state)")) +
  scale_x_log10() +
  ylim(0, 0.05) + 
  labs(x = "log(time) [min]", y = "Average uncertainty", title = "Uncertainty change in out time") +
  theme(legend.title = element_blank(),
        legend.position = "bottom")

```

## Example workflow 2

```{r warning=FALSE}
library(HaDeX)

# file import
dat_2 <-  read_hdx(system.file(package = "HaDeX", 
                               "HaDeX/data/KD_190304_Nucb2_EDTA_CaCl2_test02_clusterdata.csv"))

# protein sequence reconstruction
reconstruct_sequence(dat_2)

# calculate data
calc_dat_2 <- prepare_dataset(dat = dat_2,
                              in_state_first = "gg_Nucb2_EDTA_0.001",
                              chosen_state_first = "gg_Nucb2_EDTA_25",
                              out_state_first = "gg_Nucb2_EDTA_1440",
                              in_state_second = "gg_Nucb2_CaCl2_0.001",
                              chosen_state_second = "gg_Nucb2_CaCl2_25",
                              out_state_second = "gg_Nucb2_CaCl2_1440")                             

# theoretical comparison plot - relative values
comparison_plot(calc_dat = calc_dat_2,
                theoretical = TRUE,
                relative = TRUE,
                state_first = "Nucb2 Factor 1",
                state_second = "Nucb2 Factor 2") +
  labs(title = "Theoretical fraction exchanged in \nstate comparison in 25 min time")

# experimental comparison plot - relative values 
comparison_plot(calc_dat = calc_dat_2,
                theoretical = FALSE,
                relative = TRUE,
                state_first = "Nucb2 Factor 1",
                state_second = "Nucb2 Factor 2") +
  labs(title = "Fraction exchanged in \nstate comparison in 25 min time")

# theoretical comparison plot - absolute values
comparison_plot(calc_dat = calc_dat_2,
                theoretical = TRUE,
                relative = FALSE,
                state_first = "Nucb2 Factor 1",
                state_second = "Nucb2 Factor 2") +
  labs(title = "Theoretical fraction exchanged in \nstate comparison in 25 min time")

# experimental comparison plot - absolute values 
comparison_plot(calc_dat = calc_dat_2,
                theoretical = FALSE,
                relative = FALSE,
                state_first = "Nucb2 Factor 1",
                state_second = "Nucb2 Factor 2") +
  labs(title = "Fraction exchanged in \nstate comparison in 25 min time")

# theoretical Woods plot - relative values
woods_plot(calc_dat = calc_dat_2,
           theoretical = TRUE,
           relative = TRUE) + 
  labs(title = "Theoretical fraction exchanged between states in 25 min time") +
  coord_cartesian(ylim = c(-.5, .7))

# experimental Woods plot - relative values
woods_plot(calc_dat = calc_dat_2,
           theoretical = FALSE,
           relative = TRUE) +
  labs(title = "Fraction exchanged between states in 25 min time") +
  coord_cartesian(ylim = c(-.5, .7))

# theoretical Woods plot - absolute values
woods_plot(calc_dat = calc_dat_2,
           theoretical = TRUE,
           relative = FALSE) + 
  labs(title = "Theoretical fraction exchanged between states in 25 min time") 

# experimental Woods plot - absolute values
woods_plot(calc_dat = calc_dat_2,
           theoretical = FALSE,
           relative = FALSE) +
  labs(title = "Fraction exchanged between states in 25 min time") 

# quality control
(result <- quality_control(dat = dat_2,
                           state_first = "gg_Nucb2_EDTA",
                           state_second = "gg_Nucb2_CaCl2", 
                           chosen_time = 25, 
                           in_time = 0.001))

# example quality control visualisation - relative values
library(ggplot2)
ggplot(result[result["time"]>=1,]) + 
  geom_line(aes(x = time, y = avg_err_state_first, color = "Average error (first state)")) +
  geom_line(aes(x = time, y = avg_err_state_second, color = "Average error (second state)")) +
  scale_x_log10() +
  labs(x = "log(time) [min]", y = "Average uncertainty", title = "Uncertainty change") + 
  theme(legend.position = "bottom",
        legend.title = element_blank())
```
